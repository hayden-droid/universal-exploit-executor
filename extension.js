const vscode = require("vscode")

const execute_button = vscode.window.createStatusBarItem(vscode.StatusBarAlignment.Left)
execute_button.tooltip = "Execute Script"
execute_button.command = "universal-exploit-executor.exploitExecute"

// start websocket server

let [web_socket_server, web_socket] = [new require("ws").Server, null]

new web_socket_server({port: 41738}).on("connection", function(websocket) {
	let first_message = true

	websocket.on("message", function(message) {
		if (!first_message) {
			vscode.window.showErrorMessage(`There was an error in your script: ${message}`)
		} else {
			execute_button.text = `$(notebook-execute) ${message} Execute` // sets button title to exploit name
			first_message = false
		}
	})

	websocket.on("close", function() {
		execute_button.hide()
	})

	web_socket = websocket
	execute_button.show()
})

function activate(context) {
	context.subscriptions.push(vscode.commands.registerCommand("universal-exploit-executor.exploitExecute", function() {
		// i know i don't need the brackets but i think it looks better with them
		if (web_socket) {
			web_socket.send(vscode.window.activeTextEditor.document.getText())
		}
	}))
}

// this method is called when your extension is deactivated
function deactivate() {
	execute_button.dispose()
}

module.exports = {
	activate,
	deactivate
}